-- Stage 4: Agent Orchestration Database Migration\n-- Add tables for AutoGen, LangGraph, Cost Orchestration, and Determinism tracking\n\n-- Agent Research Sessions\nCREATE TABLE IF NOT EXISTS agent_research_sessions (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    session_id VARCHAR(255) UNIQUE NOT NULL,\n    objective TEXT NOT NULL,\n    initial_context JSONB DEFAULT '{}',\n    execution_plan JSONB,\n    step_results JSONB DEFAULT '[]',\n    final_answer TEXT,\n    status VARCHAR(50) DEFAULT 'pending' CHECK (status IN ('pending', 'in_progress', 'completed', 'partial', 'failed', 'cancelled')),\n    metadata JSONB DEFAULT '{}',\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- LangGraph State Definitions\nCREATE TABLE IF NOT EXISTS langgraph_definitions (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    graph_id VARCHAR(255) UNIQUE NOT NULL,\n    name VARCHAR(255) NOT NULL,\n    initial_state VARCHAR(255) NOT NULL,\n    states JSONB NOT NULL DEFAULT '[]',\n    transitions JSONB NOT NULL DEFAULT '[]',\n    max_execution_time INTEGER DEFAULT 300000,\n    max_steps INTEGER DEFAULT 50,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- LangGraph Executions\nCREATE TABLE IF NOT EXISTS langgraph_executions (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    execution_id VARCHAR(255) UNIQUE NOT NULL,\n    graph_id VARCHAR(255) NOT NULL REFERENCES langgraph_definitions(graph_id) ON DELETE CASCADE,\n    current_state VARCHAR(255) NOT NULL,\n    execution_data JSONB DEFAULT '{}',\n    history JSONB DEFAULT '[]',\n    status VARCHAR(50) DEFAULT 'active' CHECK (status IN ('active', 'completed', 'failed', 'cancelled')),\n    step_count INTEGER DEFAULT 0,\n    started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    completed_at TIMESTAMP WITH TIME ZONE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- Cost Orchestrator Tasks\nCREATE TABLE IF NOT EXISTS orchestrator_tasks (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    task_id VARCHAR(255) UNIQUE NOT NULL,\n    priority VARCHAR(20) NOT NULL CHECK (priority IN ('low', 'medium', 'high', 'critical')),\n    estimated_tokens INTEGER NOT NULL,\n    max_tokens INTEGER NOT NULL,\n    model VARCHAR(100) NOT NULL,\n    cache_key VARCHAR(255),\n    estimated_cost DECIMAL(10, 6) DEFAULT 0,\n    actual_cost DECIMAL(10, 6),\n    status VARCHAR(50) DEFAULT 'queued' CHECK (status IN ('queued', 'processing', 'completed', 'failed', 'cancelled')),\n    queue_position INTEGER,\n    retry_count INTEGER DEFAULT 0,\n    metadata JSONB DEFAULT '{}',\n    queued_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    started_at TIMESTAMP WITH TIME ZONE,\n    completed_at TIMESTAMP WITH TIME ZONE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- Cost Orchestrator Metrics (hourly aggregates)\nCREATE TABLE IF NOT EXISTS orchestrator_metrics (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    hour_bucket TIMESTAMP WITH TIME ZONE NOT NULL,\n    total_tokens INTEGER DEFAULT 0,\n    input_tokens INTEGER DEFAULT 0,\n    output_tokens INTEGER DEFAULT 0,\n    total_cost DECIMAL(10, 6) DEFAULT 0,\n    cache_hits INTEGER DEFAULT 0,\n    cache_misses INTEGER DEFAULT 0,\n    cost_savings DECIMAL(10, 6) DEFAULT 0,\n    tasks_completed INTEGER DEFAULT 0,\n    tasks_failed INTEGER DEFAULT 0,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    UNIQUE(hour_bucket)\n);\n\n-- Determinism Execution Contexts\nCREATE TABLE IF NOT EXISTS determinism_contexts (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    context_id VARCHAR(255) UNIQUE NOT NULL,\n    prompt TEXT NOT NULL,\n    config JSONB NOT NULL,\n    context_hash VARCHAR(64) NOT NULL,\n    execution_count INTEGER DEFAULT 1,\n    last_executed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- Determinism Execution Results\nCREATE TABLE IF NOT EXISTS determinism_results (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    context_id VARCHAR(255) NOT NULL REFERENCES determinism_contexts(context_id) ON DELETE CASCADE,\n    content TEXT NOT NULL,\n    content_hash VARCHAR(32) NOT NULL,\n    model VARCHAR(100) NOT NULL,\n    tokens_used INTEGER DEFAULT 0,\n    execution_time INTEGER DEFAULT 0,\n    reproducibility_score DECIMAL(5, 4) DEFAULT 0,\n    metadata JSONB DEFAULT '{}',\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- Reproducibility Tests\nCREATE TABLE IF NOT EXISTS reproducibility_tests (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    test_id VARCHAR(255) UNIQUE NOT NULL,\n    prompt TEXT NOT NULL,\n    config JSONB NOT NULL,\n    iterations INTEGER NOT NULL,\n    tolerance_threshold DECIMAL(5, 4) NOT NULL,\n    model VARCHAR(100) NOT NULL,\n    passed BOOLEAN,\n    reproducibility_score DECIMAL(5, 4),\n    unique_outputs INTEGER,\n    most_common_output TEXT,\n    variance DECIMAL(5, 4),\n    results JSONB DEFAULT '[]',\n    started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    completed_at TIMESTAMP WITH TIME ZONE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- MCP (Model Context Protocol) Contexts\nCREATE TABLE IF NOT EXISTS mcp_contexts (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    context_id VARCHAR(255) UNIQUE NOT NULL,\n    step_id VARCHAR(255) NOT NULL,\n    description TEXT NOT NULL,\n    required_tools JSONB DEFAULT '[]',\n    context_data JSONB DEFAULT '{}',\n    status VARCHAR(50) DEFAULT 'active' CHECK (status IN ('active', 'completed', 'failed', 'cancelled')),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- MCP Shared Data\nCREATE TABLE IF NOT EXISTS mcp_shared_data (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    data_key VARCHAR(255) UNIQUE NOT NULL,\n    data_value JSONB NOT NULL,\n    ttl_expires_at TIMESTAMP WITH TIME ZONE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- Create indexes for performance\nCREATE INDEX IF NOT EXISTS idx_agent_research_sessions_session_id ON agent_research_sessions(session_id);\nCREATE INDEX IF NOT EXISTS idx_agent_research_sessions_status ON agent_research_sessions(status);\nCREATE INDEX IF NOT EXISTS idx_agent_research_sessions_created_at ON agent_research_sessions(created_at DESC);\n\nCREATE INDEX IF NOT EXISTS idx_langgraph_definitions_graph_id ON langgraph_definitions(graph_id);\nCREATE INDEX IF NOT EXISTS idx_langgraph_executions_execution_id ON langgraph_executions(execution_id);\nCREATE INDEX IF NOT EXISTS idx_langgraph_executions_graph_id ON langgraph_executions(graph_id);\nCREATE INDEX IF NOT EXISTS idx_langgraph_executions_status ON langgraph_executions(status);\n\nCREATE INDEX IF NOT EXISTS idx_orchestrator_tasks_task_id ON orchestrator_tasks(task_id);\nCREATE INDEX IF NOT EXISTS idx_orchestrator_tasks_status ON orchestrator_tasks(status);\nCREATE INDEX IF NOT EXISTS idx_orchestrator_tasks_priority ON orchestrator_tasks(priority);\nCREATE INDEX IF NOT EXISTS idx_orchestrator_tasks_queued_at ON orchestrator_tasks(queued_at);\n\nCREATE INDEX IF NOT EXISTS idx_orchestrator_metrics_hour_bucket ON orchestrator_metrics(hour_bucket);\n\nCREATE INDEX IF NOT EXISTS idx_determinism_contexts_context_id ON determinism_contexts(context_id);\nCREATE INDEX IF NOT EXISTS idx_determinism_contexts_hash ON determinism_contexts(context_hash);\nCREATE INDEX IF NOT EXISTS idx_determinism_results_context_id ON determinism_results(context_id);\nCREATE INDEX IF NOT EXISTS idx_determinism_results_content_hash ON determinism_results(content_hash);\n\nCREATE INDEX IF NOT EXISTS idx_reproducibility_tests_test_id ON reproducibility_tests(test_id);\nCREATE INDEX IF NOT EXISTS idx_reproducibility_tests_created_at ON reproducibility_tests(created_at DESC);\n\nCREATE INDEX IF NOT EXISTS idx_mcp_contexts_context_id ON mcp_contexts(context_id);\nCREATE INDEX IF NOT EXISTS idx_mcp_contexts_status ON mcp_contexts(status);\nCREATE INDEX IF NOT EXISTS idx_mcp_shared_data_key ON mcp_shared_data(data_key);\nCREATE INDEX IF NOT EXISTS idx_mcp_shared_data_ttl ON mcp_shared_data(ttl_expires_at) WHERE ttl_expires_at IS NOT NULL;\n\n-- Create triggers for updated_at timestamps\nCREATE OR REPLACE FUNCTION update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = NOW();\n    RETURN NEW;\nEND;\n$$ language 'plpgsql';\n\n-- Apply triggers to all tables\nCREATE TRIGGER update_agent_research_sessions_updated_at BEFORE UPDATE ON agent_research_sessions FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\nCREATE TRIGGER update_langgraph_definitions_updated_at BEFORE UPDATE ON langgraph_definitions FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\nCREATE TRIGGER update_langgraph_executions_updated_at BEFORE UPDATE ON langgraph_executions FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\nCREATE TRIGGER update_orchestrator_tasks_updated_at BEFORE UPDATE ON orchestrator_tasks FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\nCREATE TRIGGER update_orchestrator_metrics_updated_at BEFORE UPDATE ON orchestrator_metrics FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\nCREATE TRIGGER update_determinism_contexts_updated_at BEFORE UPDATE ON determinism_contexts FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\nCREATE TRIGGER update_reproducibility_tests_updated_at BEFORE UPDATE ON reproducibility_tests FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\nCREATE TRIGGER update_mcp_contexts_updated_at BEFORE UPDATE ON mcp_contexts FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\nCREATE TRIGGER update_mcp_shared_data_updated_at BEFORE UPDATE ON mcp_shared_data FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\n-- Create cleanup function for expired data\nCREATE OR REPLACE FUNCTION cleanup_expired_data()\nRETURNS INTEGER AS $$\nDECLARE\n    deleted_count INTEGER := 0;\nBEGIN\n    -- Cleanup expired MCP shared data\n    DELETE FROM mcp_shared_data \n    WHERE ttl_expires_at IS NOT NULL AND ttl_expires_at < NOW();\n    GET DIAGNOSTICS deleted_count = ROW_COUNT;\n    \n    -- Cleanup old completed executions (older than 7 days)\n    DELETE FROM langgraph_executions \n    WHERE status IN ('completed', 'failed', 'cancelled') \n    AND completed_at < NOW() - INTERVAL '7 days';\n    \n    -- Cleanup old orchestrator tasks (older than 30 days)\n    DELETE FROM orchestrator_tasks \n    WHERE status IN ('completed', 'failed', 'cancelled') \n    AND completed_at < NOW() - INTERVAL '30 days';\n    \n    -- Cleanup old research sessions (older than 30 days)\n    DELETE FROM agent_research_sessions \n    WHERE status IN ('completed', 'failed', 'cancelled') \n    AND updated_at < NOW() - INTERVAL '30 days';\n    \n    RETURN deleted_count;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- Schedule cleanup to run daily (requires pg_cron extension)\n-- SELECT cron.schedule('cleanup-expired-data', '0 2 * * *', 'SELECT cleanup_expired_data();');\n\nCOMMIT;