generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Multi-Tenant Support
model Tenant {
  id        String   @id @default(uuid())
  name      String
  domain    String?  @unique
  apiKey    String   @unique @default(uuid())
  config    Json     @default("{}")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users                 User[]
  roles                 Role[]
  auditLogs             AuditLog[]
  webhooks              Webhook[]
  operationalMetrics    OperationalMetrics[]
  requestSignatures     RequestSignature[]
  collaborationSessions CollaborationSession[]
  marketplacePrompts    MarketplacePrompt[]
  prompts               Prompt[]
  promptTemplates       PromptTemplate[]
  evaluationDatasets    EvaluationDataset[]
  optimizationRuns      OptimizationRun[]
  promptAuditEvents     PromptAuditEvent[]

  @@index([domain])
  @@index([isActive])
}

// RBAC System
model Role {
  id          String   @id @default(uuid())
  name        String
  description String?
  tenantId    String?
  isSystem    Boolean  @default(false) // System roles cannot be deleted
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant      Tenant?          @relation(fields: [tenantId], references: [id])
  userRoles   UserRole[]
  permissions RolePermission[]

  @@unique([name, tenantId])
  @@index([tenantId])
  @@index([isActive])
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  resource    String // e.g., "prompts", "sessions", "marketplace"
  action      String // e.g., "create", "read", "update", "delete", "publish"
  description String?
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())

  // Relations
  rolePermissions RolePermission[]

  @@unique([resource, action])
}

model RolePermission {
  id           String @id @default(uuid())
  roleId       String
  permissionId String

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model UserRole {
  id     String @id @default(uuid())
  userId String
  roleId String

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

// Audit Logging
model AuditLog {
  id           String   @id @default(uuid())
  tenantId     String?
  userId       String?
  action       String // e.g., "CREATE", "UPDATE", "DELETE", "LOGIN"
  resource     String // e.g., "user", "prompt", "session"
  resourceId   String?
  details      Json     @default("{}")
  ipAddress    String?
  userAgent    String?
  timestamp    DateTime @default(now())
  success      Boolean  @default(true)
  errorMessage String?

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id])
  user   User?   @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([timestamp])
  @@index([tenantId, timestamp])
  @@index([tenantId, action])
  @@index([tenantId, resource])
  @@index([userId, timestamp])
}

// Webhooks
model Webhook {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  url       String
  secret    String // For signature verification
  events    String[] // Array of events to trigger on
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([isActive])
}

// Performance and Partitioning Indexes
// Multi-tenant query optimization

// Operational Analytics
model OperationalMetrics {
  id         String   @id @default(uuid())
  tenantId   String?
  date       DateTime @db.Date
  metricType String // "usage", "cost", "quality", "reliability"
  metricName String
  value      Float
  metadata   Json     @default("{}")
  createdAt  DateTime @default(now())

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, date, metricType, metricName])
  @@index([tenantId])
  @@index([date])
  @@index([metricType])
  @@index([tenantId, date, metricType])
  @@index([tenantId, metricType, date])
}

// Request Signing
model RequestSignature {
  id        String    @id @default(uuid())
  userId    String?
  tenantId  String?
  signature String
  timestamp DateTime
  expiresAt DateTime
  usedAt    DateTime?
  isValid   Boolean   @default(true)

  // Relations
  user   User?   @relation(fields: [userId], references: [id])
  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@index([userId])
  @@index([tenantId])
  @@index([signature])
  @@index([expiresAt])
}

// User model
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  avatar    String?
  color     String   @default("#3B82F6")
  tenantId  String? // For multi-tenancy
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownedSessions      CollaborationSession[] @relation("SessionOwner")
  sessionMembers     SessionMember[]
  editHistory        EditHistory[]
  comments           Comment[]
  cacheEntries       SemanticCache[]
  marketplacePrompts MarketplacePrompt[]
  marketplaceReviews MarketplaceReview[]
  userRoles          UserRole[]
  auditLogs          AuditLog[]
  tenant             Tenant?                @relation(fields: [tenantId], references: [id])
  requestSignatures  RequestSignature[]
  ownedPrompts       Prompt[]               @relation("PromptOwner")
  promptAuditEvents  PromptAuditEvent[]     @relation("PromptAuditActor")

  // DSPy Optimization relations
  ownedTemplates     PromptTemplate[]       @relation("TemplateOwner")
  createdVersions    TemplateVersion[]      @relation("VersionCreator")
  createdDatasets    EvaluationDataset[]    @relation("DatasetCreator")
  createdEvaluations EvaluationRun[]        @relation("EvaluationCreator")
  createdOptimizations OptimizationRun[]    @relation("OptimizationCreator")

  // Performance indexes for multi-tenant queries
  @@index([tenantId, updatedAt])
  @@index([email, tenantId])
}

// Collaboration Session
model CollaborationSession {
  id          String   @id @default(uuid())
  name        String
  description String?
  content     String   @default("")
  isActive    Boolean  @default(true)
  shareToken  String   @unique @default(uuid())
  tenantId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Owner relation
  ownerId String
  owner   User   @relation("SessionOwner", fields: [ownerId], references: [id])

  // Relations
  members     SessionMember[]
  editHistory EditHistory[]
  comments    Comment[]
  snapshots   SessionSnapshot[]
  tenant      Tenant?           @relation(fields: [tenantId], references: [id])

  @@index([ownerId])
  @@index([shareToken])
  @@index([tenantId])
  @@index([tenantId, ownerId])
  @@index([tenantId, createdAt])
  @@index([tenantId, isActive])
}

// Session Members with permissions
model SessionMember {
  id         String     @id @default(uuid())
  role       MemberRole @default(VIEWER)
  joinedAt   DateTime   @default(now())
  lastSeenAt DateTime   @default(now())

  // Relations
  userId    String
  user      User                 @relation(fields: [userId], references: [id])
  sessionId String
  session   CollaborationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([userId, sessionId])
  @@index([sessionId])
}

enum MemberRole {
  OWNER
  EDITOR
  VIEWER
}

// Edit History for versioning
model EditHistory {
  id            String   @id @default(uuid())
  operation     String // JSON string of the operation
  contentBefore String?
  contentAfter  String?
  timestamp     DateTime @default(now())

  // Relations
  userId    String
  user      User                 @relation(fields: [userId], references: [id])
  sessionId String
  session   CollaborationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, timestamp])
}

// Session Snapshots for major versions
model SessionSnapshot {
  id        String   @id @default(uuid())
  name      String
  content   String
  createdAt DateTime @default(now())

  // Relations
  sessionId String
  session   CollaborationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

// Comments and Annotations
model Comment {
  id        String   @id @default(uuid())
  content   String
  position  Json? // { start: number, end: number } for inline comments
  resolved  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Parent comment for threads
  parentId String?
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies")

  // Relations
  userId    String
  user      User                 @relation(fields: [userId], references: [id])
  sessionId String
  session   CollaborationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([parentId])
}

// Semantic Cache
model SemanticCache {
  id             String   @id @default(uuid())
  prompt         String
  promptHash     String
  embedding      Json // Vector embedding stored as JSON array
  response       String
  model          String
  hitCount       Int      @default(0)
  tokensSaved    Int      @default(0)
  createdAt      DateTime @default(now())
  expiresAt      DateTime
  lastAccessedAt DateTime @default(now())

  // User who created this cache entry
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // Tags for invalidation
  tags CacheTag[]

  @@index([promptHash])
  @@index([expiresAt])
}

// Cache Tags for invalidation
model CacheTag {
  id   String @id @default(uuid())
  name String

  cacheId String
  cache   SemanticCache @relation(fields: [cacheId], references: [id], onDelete: Cascade)

  @@index([name])
}

// Cache Statistics
model CacheStatistics {
  id          String   @id @default(uuid())
  date        DateTime @default(now()) @db.Date
  totalHits   Int      @default(0)
  totalMisses Int      @default(0)
  tokensSaved Int      @default(0)
  costSaved   Float    @default(0)

  @@unique([date])
}

// Partitioning and Performance Indexes
// Add composite indexes for better query performance

// Cache Configuration
model CacheConfig {
  id                  String  @id @default(uuid())
  enabled             Boolean @default(true)
  similarityThreshold Float   @default(0.85)
  defaultTTLSeconds   Int     @default(3600)
  maxCacheSize        Int     @default(10000)

  // Invalidation rules as JSON
  invalidationRules Json @default("[]")

  updatedAt DateTime @updatedAt
}

// Marketplace Prompt
model MarketplacePrompt {
  id          String  @id @default(uuid())
  authorId    String?
  authorName  String  @default("Anonymous")
  title       String
  description String
  tenantId    String?
  content     String

  // Hierarchical Prompt Structure
  systemPrompt  String?
  processPrompt String?
  taskPrompt    String?
  outputPrompt  String?

  // Meta-Prompting
  persona          String?
  domain           String?
  timeConstraint   String? // e.g., "urgent", "standard", "comprehensive"
  metaInstructions Json?   @default("{}")

  // Advanced Features
  reasoningMode  String  @default("default") // default, tree-of-thought, graph-of-thought
  ragEnabled     Boolean @default(false)
  ragSources     Json?   @default("[]")
  toolPlanning   Boolean @default(false)
  selfRefinement Boolean @default(false)

  // Safety & Pre-send
  safetyChecks   Boolean @default(true)
  toxicityFilter Boolean @default(true)
  piiDetection   Boolean @default(true)

  // Cost & Performance
  estimatedTokens    Int?
  estimatedCost      Float?
  successProbability Float?

  category            String
  tags                String[]
  modelRecommendation String   @default("gpt-4")
  variables           Json     @default("[]")
  avgRating           Float    @default(0)
  reviewCount         Int      @default(0)
  cloneCount          Int      @default(0)
  viewCount           Int      @default(0)
  isFeatured          Boolean  @default(false)
  isStaffPick         Boolean  @default(false)
  status              String   @default("pending")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  author         User?               @relation(fields: [authorId], references: [id])
  reviews        MarketplaceReview[]
  promptVersions PromptVersion[]
  promptChains   PromptChain[]
  tenant         Tenant?             @relation(fields: [tenantId], references: [id])

  @@index([status])
  @@index([category])
  @@index([isFeatured])
  @@index([avgRating])
  @@index([persona])
  @@index([domain])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, category])
  @@index([tenantId, avgRating])
  @@index([tenantId, createdAt])
}

// Prompt Version for Self-Refinement History
model PromptVersion {
  id            String  @id @default(uuid())
  promptId      String
  promptEntityId String?
  version       Int
  content       String
  systemPrompt  String?
  processPrompt String?
  taskPrompt    String?
  outputPrompt  String?

  // Refinement Data
  refinementReason   String?
  qualityScore       Float?
  performanceMetrics Json?   @default("{}")

  createdAt DateTime @default(now())

  // Relations
  prompt MarketplacePrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  promptEntity Prompt?     @relation("PromptEntityVersions", fields: [promptEntityId], references: [id], onDelete: Cascade)
  activeForPrompt Prompt?  @relation("ActivePromptVersion")

  @@unique([promptId, version])
  @@unique([promptEntityId, version])
  @@index([promptId])
  @@index([promptEntityId])
}

// Prompt Chain for Multi-Step Processing
model PromptChain {
  id          String  @id @default(uuid())
  promptId    String
  name        String
  description String?

  // Chain Configuration
  stages        Json // Array of stage configurations
  contextMemory Json?   @default("{}")
  isActive      Boolean @default(true)

  // Pipeline settings
  pipelineType String  @default("custom") // standard, analysis, creative, technical
  enableMemory Boolean @default(true) // Enable long-term memory
  reuseContext Boolean @default(true) // Reuse context from similar tasks

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  prompt       MarketplacePrompt  @relation(fields: [promptId], references: [id], onDelete: Cascade)
  executions   ChainExecution[]
  memoryStates ChainMemoryState[]

  @@index([promptId])
  @@index([pipelineType])
}

// Chain Execution History
model ChainExecution {
  id      String @id @default(uuid())
  chainId String

  // Execution Data
  stageResults  Json // Results from each stage
  totalDuration Int // milliseconds
  totalCost     Float?
  success       Boolean @default(true)
  errorMessage  String?

  createdAt DateTime @default(now())

  // Relations
  chain PromptChain @relation(fields: [chainId], references: [id], onDelete: Cascade)

  @@index([chainId])
  @@index([createdAt])
}

// RAG Knowledge Base
model KnowledgeBase {
  id          String  @id @default(uuid())
  name        String
  description String?
  domain      String?

  // Configuration
  embeddingModel String @default("text-embedding-ada-002")
  chunkSize      Int    @default(1000)
  chunkOverlap   Int    @default(200)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  documents KnowledgeDocument[]
}

// Knowledge Document for RAG
model KnowledgeDocument {
  id              String  @id @default(uuid())
  knowledgeBaseId String
  title           String
  content         String
  source          String?

  // Metadata
  metadata   Json? @default("{}")
  trustScore Float @default(1.0)

  // Embeddings
  embedding Json? // Vector embedding

  // Source verification
  isVerified Boolean   @default(false)
  verifiedAt DateTime?
  verifiedBy String?

  // Usage statistics
  retrievalCount Int       @default(0)
  lastRetrieved  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  knowledgeBase    KnowledgeBase    @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  contextSummaries ContextSummary[]

  @@index([knowledgeBaseId])
  @@index([trustScore])
  @@index([isVerified])
}

// RAG Context Session - للتتبع الديناميكي
model RAGContextSession {
  id             String @id @default(uuid())
  query          String
  queryEmbedding Json?

  // Context configuration
  maxChunks    Int   @default(5)
  minRelevance Float @default(0.7)
  minTrust     Float @default(0.5)

  // Session results
  totalChunks  Int    @default(0)
  avgRelevance Float?
  avgTrust     Float?

  createdAt DateTime @default(now())

  // Relations
  summaries ContextSummary[]
  traces    ContextTrace[]

  @@index([createdAt])
}

// Context Summary - تلخيص المقتطفات مع مؤشرات الثقة
model ContextSummary {
  id         String @id @default(uuid())
  sessionId  String
  documentId String

  // Summary content
  originalChunk String
  summary       String

  // Quality indicators
  relevanceScore  Float
  trustScore      Float
  confidenceScore Float @default(0.8)

  // Metadata
  position         Int // Position in the final context
  tokenCount       Int   @default(0)
  compressionRatio Float @default(1.0)

  createdAt DateTime @default(now())

  // Relations
  session  RAGContextSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  document KnowledgeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([relevanceScore])
  @@index([trustScore])
}

// Context Trace - حفظ أثر المصدر
model ContextTrace {
  id        String @id @default(uuid())
  sessionId String

  // Source tracking
  sourceDocument String
  sourceTitle    String
  sourceUrl      String?

  // Injection details
  injectedAt Int // Position in final prompt
  chunkSize  Int

  // Attribution metadata
  citationFormat  String @default("inline")
  attributionText String

  createdAt DateTime @default(now())

  // Relations
  session RAGContextSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

// Trusted Source Registry - سجل المصادر الموثوقة
model TrustedSource {
  id String @id @default(uuid())

  // Source identification
  name       String
  domain     String?
  url        String?
  sourceType String  @default("document") // document, api, database, etc.

  // Trust configuration
  baseTrustScore Float   @default(0.8)
  autoVerify     Boolean @default(false)

  // Filtering rules
  includePatterns Json? @default("[]")
  excludePatterns Json? @default("[]")

  // Statistics
  documentCount   Int    @default(0)
  avgQualityScore Float? @default(0.8)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([domain])
  @@index([baseTrustScore])
}

// Marketplace Review
model MarketplaceReview {
  id           String   @id @default(uuid())
  promptId     String
  reviewerId   String?
  reviewerName String   @default("Anonymous")
  rating       Int
  reviewText   String   @default("")
  isVerified   Boolean  @default(false)
  createdAt    DateTime @default(now())

  // Relations
  prompt   MarketplacePrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  reviewer User?             @relation(fields: [reviewerId], references: [id])

  @@index([promptId])
}

// Long Term Memory for Prompt Chaining
model LongTermMemory {
  id        String   @id @default(uuid())
  type      String // task_context, stage_output, user_preference, pattern, insight
  key       String
  content   String
  metadata  Json     @default("{}")
  embedding Json? // Vector embedding for semantic search
  tags      String[] @default([])

  // Usage tracking
  accessCount    Int   @default(0)
  relevanceScore Float @default(1.0)

  // Timestamps
  createdAt      DateTime  @default(now())
  lastAccessedAt DateTime  @default(now())
  expiresAt      DateTime?

  @@unique([type, key])
  @@index([type])
  @@index([tags])
  @@index([relevanceScore])
  @@index([lastAccessedAt])
}

// Chain Memory State for persistent chain context
model ChainMemoryState {
  id        String  @id @default(uuid())
  chainId   String
  sessionId String? // Optional session binding

  // Memory state
  shortTermMemory Json     @default("{}") // Current execution context
  workingMemory   Json     @default("{}") // Intermediate results
  longTermRefs    String[] @default([]) // References to LongTermMemory records

  // Stage history
  stageHistory Json    @default("[]") // Array of stage executions
  currentStage String?

  // Metadata
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  chain PromptChain @relation(fields: [chainId], references: [id], onDelete: Cascade)

  @@unique([chainId, sessionId])
  @@index([chainId])
  @@index([isActive])
}

// ============================================================
// DSPy Optimization System - Epic 0 + Epic 1
// ============================================================

// Prompt - Core prompt entity for DSPy workflows
model Prompt {
  id              String   @id @default(uuid())
  name            String
  description     String?
  tags            String[] @default([])
  tenantId        String?
  ownerId         String?
  activeVersionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant          Tenant?        @relation(fields: [tenantId], references: [id])
  owner           User?          @relation("PromptOwner", fields: [ownerId], references: [id])
  activeVersion   PromptVersion? @relation("ActivePromptVersion", fields: [activeVersionId], references: [id])
  versions        PromptVersion[] @relation("PromptEntityVersions")
  optimizationRuns OptimizationRun[]
  evaluationRuns   EvaluationRun[]
  auditEvents      PromptAuditEvent[]

  @@index([tenantId])
  @@index([ownerId])
  @@index([activeVersionId])
  @@index([tenantId, createdAt])
}

// Prompt Template - Independent prompt templates for optimization
model PromptTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?
  category    String?
  tags        String[] @default([])

  // Multi-tenant support
  tenantId String?
  ownerId  String?

  // Active version reference
  activeVersionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant   Tenant? @relation(fields: [tenantId], references: [id])
  owner    User?   @relation("TemplateOwner", fields: [ownerId], references: [id])
  versions TemplateVersion[]
  optimizationRuns OptimizationRun[]

  @@index([tenantId])
  @@index([ownerId])
  @@index([category])
  @@index([tenantId, ownerId])
  @@index([tenantId, category])
}

// Template Version - Versioned snapshots of prompt templates
model TemplateVersion {
  id            String @id @default(uuid())
  templateId    String
  versionNumber Int

  // Content snapshot as JSON
  // Structure: { system, developer, user, context, variablesSchema, defaultValues, modelConfig }
  contentSnapshot Json

  // Metadata
  createdAt   DateTime @default(now())
  createdById String?
  isActive    Boolean  @default(false)

  // Relations
  template         PromptTemplate    @relation(fields: [templateId], references: [id], onDelete: Cascade)
  createdBy        User?             @relation("VersionCreator", fields: [createdById], references: [id])
  baseOptimizations OptimizationRun[] @relation("BaseVersion")
  optimizationResults OptimizationResult[] @relation("OptimizedVersion")

  @@unique([templateId, versionNumber])
  @@index([templateId])
  @@index([createdById])
  @@index([isActive])
}

// Evaluation Dataset - Datasets for baseline and optimization evaluation
model EvaluationDataset {
  id          String  @id @default(uuid())
  name        String
  description String?
  taskType    String? // e.g., "classification", "generation", "qa"

  // Dataset format
  format String @default("labeled") // labeled | unlabeled

  // Multi-tenant support
  tenantId    String?
  createdById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant    Tenant?          @relation(fields: [tenantId], references: [id])
  createdBy User?            @relation("DatasetCreator", fields: [createdById], references: [id])
  examples  DatasetExample[]
  optimizationRuns OptimizationRun[]
  evaluationRuns   EvaluationRun[]

  @@index([tenantId])
  @@index([createdById])
  @@index([format])
  @@index([taskType])
}

// Dataset Example - Individual examples within a dataset
model DatasetExample {
  id        String @id @default(uuid())
  datasetId String

  // Input variables as JSON (matches {{var}} in prompts)
  inputVariables Json

  // Expected output (nullable for unlabeled data)
  expectedOutput String?

  // Additional metadata
  metadata Json? @default("{}")

  createdAt DateTime @default(now())

  // Relations
  dataset EvaluationDataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@index([datasetId])
}

// Evaluation Run - Baseline evaluation results
model EvaluationRun {
  id              String @id @default(uuid())
  templateId      String?
  templateVersionId String?
  datasetId       String
  promptId        String?
  baselinePromptVersionId  String?
  optimizedPromptVersionId String?

  // Evaluation configuration
  metricType String // exact_match | contains | json_valid | custom

  // Execution status
  status       String   @default("pending") // pending | running | completed | failed
  startedAt    DateTime?
  completedAt  DateTime?
  durationMs   Int?
  errorMessage String?

  // Results
  aggregateScore Float?
  totalExamples  Int     @default(0)
  passedExamples Int     @default(0)
  failedExamples Int     @default(0)

  // Detailed results as JSON
  perExampleResults Json? @default("[]")
  failureCases      Json? @default("[]")
  topFailureCases   Json? @default("[]")

  // Cost tracking
  calls       Int   @default(0)
  tokens      Int   @default(0)
  usdEstimate Float @default(0)

  // Execution metadata
  maxSamples  Int?
  createdById String?
  createdAt   DateTime @default(now())

  // Relations
  dataset   EvaluationDataset @relation(fields: [datasetId], references: [id])
  createdBy User?             @relation("EvaluationCreator", fields: [createdById], references: [id])
  prompt    Prompt?           @relation(fields: [promptId], references: [id])
  baselinePromptVersion  PromptVersion? @relation("BaselineEvaluationPromptVersion", fields: [baselinePromptVersionId], references: [id])
  optimizedPromptVersion PromptVersion? @relation("OptimizedEvaluationPromptVersion", fields: [optimizedPromptVersionId], references: [id])

  @@index([datasetId])
  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@index([promptId])
  @@index([baselinePromptVersionId])
  @@index([optimizedPromptVersionId])
}

// Optimization Run - DSPy optimization execution
model OptimizationRun {
  id             String @id @default(uuid())
  templateId     String
  baseVersionId  String
  datasetId      String
  promptId       String?
  baselinePromptVersionId  String?
  optimizedPromptVersionId String?

  // Optimizer configuration
  optimizerType String // bootstrap_fewshot | copro
  metricType    String // exact_match | contains | json_valid | judge_rubric

  // Budget constraints as JSON
  // Structure: { maxCalls?, maxTokens?, maxUSD? }
  budget Json @default("{}")

  // Execution status
  status       String   @default("queued") // queued | running | succeeded | failed | canceled
  progress     Int      @default(0) // 0-100
  stage        String?  // Current stage description
  errorMessage String?

  // Timestamps
  createdAt  DateTime  @default(now())
  startedAt  DateTime?
  finishedAt DateTime?
  durationMs Int?

  // Cost tracking
  calls       Int   @default(0)
  tokens      Int   @default(0)
  usdEstimate Float @default(0)

  // Multi-tenant support
  tenantId    String?
  createdById String?

  // Relations
  template    PromptTemplate    @relation(fields: [templateId], references: [id])
  baseVersion TemplateVersion   @relation("BaseVersion", fields: [baseVersionId], references: [id])
  dataset     EvaluationDataset @relation(fields: [datasetId], references: [id])
  tenant      Tenant?           @relation(fields: [tenantId], references: [id])
  createdBy   User?             @relation("OptimizationCreator", fields: [createdById], references: [id])
  prompt      Prompt?           @relation(fields: [promptId], references: [id])
  baselinePromptVersion  PromptVersion? @relation("BaselineOptimizationPromptVersion", fields: [baselinePromptVersionId], references: [id])
  optimizedPromptVersion PromptVersion? @relation("OptimizedOptimizationPromptVersion", fields: [optimizedPromptVersionId], references: [id])
  result      OptimizationResult?

  @@index([templateId])
  @@index([datasetId])
  @@index([status])
  @@index([createdById])
  @@index([tenantId])
  @@index([createdAt])
  @@index([promptId])
  @@index([baselinePromptVersionId])
  @@index([optimizedPromptVersionId])
}

// Optimization Result - Results from DSPy optimization
model OptimizationResult {
  id    String @id @default(uuid())
  runId String @unique

  // Optimized prompt snapshot as JSON
  // Structure: { system, developer, demos? }
  optimizedSnapshot Json

  // DSPy artifact (can be large)
  dspyArtifactJson Json?
  // Patch artifact for prompt diffs
  patchJson        Json?

  // Score comparison
  baselineScore   Float?
  optimizedScore  Float?
  scoreDelta      Float?

  // Cost tracking as JSON
  // Structure: { calls, tokens, usdEstimate }
  cost Json? @default("{}")

  // Diagnostics as JSON
  // Structure: { topFailureCases: [...] }
  diagnostics     Json? @default("{}")
  topFailureCases Json? @default("[]")

  // Link to new version if applied
  appliedVersionId String?

  createdAt DateTime @default(now())

  // Relations
  run            OptimizationRun  @relation(fields: [runId], references: [id], onDelete: Cascade)
  appliedVersion TemplateVersion? @relation("OptimizedVersion", fields: [appliedVersionId], references: [id])

  @@index([runId])
  @@index([appliedVersionId])
}

// Prompt Audit Event - change tracking and observability
model PromptAuditEvent {
  id                  String   @id @default(uuid())
  promptId            String
  promptVersionId     String?
  optimizationRunId   String?
  evaluationRunId     String?
  tenantId            String?
  actorId             String?
  eventType           String
  details             Json     @default("{}")
  createdAt           DateTime @default(now())

  // Relations
  prompt          Prompt          @relation(fields: [promptId], references: [id], onDelete: Cascade)
  promptVersion   PromptVersion?  @relation(fields: [promptVersionId], references: [id], onDelete: Cascade)
  optimizationRun OptimizationRun? @relation(fields: [optimizationRunId], references: [id], onDelete: SetNull)
  evaluationRun   EvaluationRun?  @relation(fields: [evaluationRunId], references: [id], onDelete: SetNull)
  tenant          Tenant?         @relation(fields: [tenantId], references: [id])
  actor           User?           @relation("PromptAuditActor", fields: [actorId], references: [id])

  @@index([promptId])
  @@index([promptVersionId])
  @@index([optimizationRunId])
  @@index([evaluationRunId])
  @@index([tenantId])
  @@index([actorId])
  @@index([eventType])
  @@index([createdAt])
  @@index([promptId, createdAt])
}

// ============================================================
// EPIC 2 - Evaluation & Metrics Framework
// ============================================================

// Judge Rubric - LLM-as-a-Judge evaluation criteria
model JudgeRubric {
  id          String  @id @default(uuid())
  name        String
  description String?

  // Rubric definition as JSON
  // Structure: { criteria: [...], weights: {...}, instructions: string }
  rubricJson Json

  // Model configuration for the judge
  // Structure: { model: string, temperature: number, maxTokens: number }
  modelConfig Json @default("{\"model\": \"gpt-4\", \"temperature\": 0.1, \"maxTokens\": 1024}")

  // Multi-tenant support
  workspaceId String?
  createdById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  evaluationRuns AdvancedEvaluationRun[]

  @@index([workspaceId])
  @@index([createdById])
}

// Advanced Evaluation Run - Enhanced evaluation with judge support
model AdvancedEvaluationRun {
  id              String @id @default(uuid())
  templateId      String?
  versionId       String?
  datasetId       String

  // Evaluation mode
  mode String @default("baseline") // baseline | compare

  // For comparison mode
  versionAId String?
  versionBId String?

  // Metric configuration
  metricType    String  // exact_match | contains | json_valid | judge_rubric | pairwise_judge
  judgeRubricId String?

  // Execution status
  status       String   @default("queued") // queued | running | succeeded | failed | canceled
  progress     Int      @default(0) // 0-100
  stage        String?

  // Budget constraints
  // Structure: { maxCalls?, maxTokens?, maxUSD? }
  budget Json @default("{}")

  // Cost tracking
  // Structure: { calls, tokens, usdEstimate }
  cost Json? @default("{}")

  // Results
  score        Float?
  scoreA       Float? // For compare mode
  scoreB       Float? // For compare mode
  winsA        Int?   // For pairwise compare
  winsB        Int?   // For pairwise compare
  ties         Int?   // For pairwise compare

  // Failure summary
  topFailures Json? @default("[]")

  // Timestamps
  createdAt  DateTime  @default(now())
  startedAt  DateTime?
  finishedAt DateTime?

  // Multi-tenant support
  workspaceId String?
  createdById String?

  errorMessage String?

  // Relations
  judgeRubric JudgeRubric?          @relation(fields: [judgeRubricId], references: [id])
  results     AdvancedEvalResult[]

  @@index([datasetId])
  @@index([status])
  @@index([workspaceId])
  @@index([createdById])
  @@index([createdAt])
  @@index([metricType])
}

// Advanced Evaluation Result - Per-example results
model AdvancedEvalResult {
  id     String @id @default(uuid())
  runId  String
  exampleId String

  // Output from LLM
  outputText String

  // Evaluation result
  passed Boolean @default(false)
  score  Float?

  // For pairwise comparison
  outputTextA    String?
  outputTextB    String?
  winner         String? // "A" | "B" | "tie"
  winnerReason   String?

  // Failure analysis
  failureReason String?

  // Judge details (for judge_rubric or pairwise)
  // Structure: { reasoning, scores: {...}, rawResponse }
  judgeDetails Json?

  // Latency tracking
  latencyMs Int?

  createdAt DateTime @default(now())

  // Relations
  run AdvancedEvaluationRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@index([exampleId])
  @@index([passed])
}

// ============================================================
// EPIC 3 - Governance, Budgets, Rate Limits
// ============================================================

// Workspace Policy - Budget and rate limit policies
model WorkspacePolicy {
  id          String @id @default(uuid())
  workspaceId String @unique

  // Concurrency limits
  maxActiveOptimizationRuns Int @default(1)
  maxActiveEvaluationRuns   Int @default(2)

  // Per-run budget limits
  maxCallsPerRun  Int   @default(100)
  maxTokensPerRun Int   @default(100000)
  maxUSDPerRun    Float @default(10.0)

  // Daily workspace budget
  dailyBudgetUSD   Float @default(50.0)
  dailyBudgetUsed  Float @default(0.0)
  dailyBudgetReset DateTime @default(now())

  // Rate limiting
  requestsPerMinute Int @default(60)
  requestsPerHour   Int @default(1000)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
}

// Audit Event - Detailed audit trail for governance
model AuditEvent {
  id          String @id @default(uuid())
  actorId     String?
  workspaceId String?

  // Event classification
  eventType  String // OPTIMIZE_RUN_CREATED | OPTIMIZE_APPLIED | EVAL_RUN_CREATED | VERSION_ACTIVATED | RUBRIC_CREATED | RUBRIC_UPDATED | BUDGET_EXCEEDED | RATE_LIMITED
  entityType String // optimization_run | evaluation_run | template_version | rubric | policy
  entityId   String?

  // Event payload
  payloadJson Json @default("{}")

  // Request context
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([actorId])
  @@index([workspaceId])
  @@index([eventType])
  @@index([entityType])
  @@index([createdAt])
  @@index([workspaceId, createdAt])
  @@index([workspaceId, eventType])
}

// Rate Limit Tracker - For rate limiting enforcement
model RateLimitEntry {
  id          String @id @default(uuid())
  identifier  String // userId or IP address
  endpoint    String
  windowStart DateTime
  requestCount Int @default(1)

  @@unique([identifier, endpoint, windowStart])
  @@index([identifier])
  @@index([windowStart])
}

// ============================================================
// EPIC 4 - Prompt Quality Engine
// ============================================================

// Technique - Prompt engineering techniques library
model Technique {
  id               String   @id @default(uuid())
  name             String
  descriptionShort String
  descriptionFull  String?

  // Categorization
  category String // output_structuring | role_instruction | few_shot_demos | evaluation_robustness
  tags     String[] @default([])

  // Usage guidance
  whenToUse           String?
  antiPatternExample  String?
  goodExample         String?

  // Auto-apply patch (JSON patch format)
  // Structure: { operations: [{ path, value, insert_position? }] }
  applyPatchJson Json?

  // Multi-tenant support
  workspaceId String?
  createdById String?

  // Status
  isBuiltIn Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, workspaceId])
  @@index([category])
  @@index([workspaceId])
  @@index([isBuiltIn])
  @@index([isActive])
}

// Critique Run - LLM-based prompt critique execution
model CritiqueRun {
  id              String @id @default(uuid())
  templateId      String
  versionId       String?
  datasetId       String?

  // Critique mode
  mode String @default("full") // quick | full | deep

  // Execution status
  status       String   @default("queued") // queued | running | completed | failed | canceled
  progress     Int      @default(0) // 0-100
  stage        String?
  errorMessage String?

  // Budget constraints
  // Structure: { maxCalls?, maxTokens?, maxUSD? }
  budget Json @default("{}")

  // Cost tracking
  // Structure: { calls, tokens, usdEstimate }
  cost Json? @default("{}")

  // Timestamps
  createdAt  DateTime  @default(now())
  startedAt  DateTime?
  finishedAt DateTime?

  // Multi-tenant support
  workspaceId String?
  createdById String?

  // Relations
  result CritiqueResult?

  @@index([templateId])
  @@index([status])
  @@index([workspaceId])
  @@index([createdById])
  @@index([createdAt])
}

// Critique Result - Detailed critique findings
model CritiqueResult {
  id    String @id @default(uuid())
  runId String @unique

  // Overall summary
  summary      String
  overallScore Float? // 0-100

  // Detailed issues found
  // Structure: [{ id, severity, category, description, location?, suggestion? }]
  issuesJson Json @default("[]")

  // Improvement suggestions
  // Structure: [{ id, techniqueId?, title, description, priority, effort }]
  suggestionsJson Json @default("[]")

  // Proposed improved prompt (full snapshot)
  // Structure: { system, developer, user, context }
  proposedPromptSnapshot Json?

  // Analysis metadata
  // Structure: { executionTimeMs, tokensUsed, llmModel }
  analysisMetadata Json? @default("{}")

  createdAt DateTime @default(now())

  // Relations
  run CritiqueRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
}

// ============================================================
// EPIC 5 - Collaboration & Distribution
// ============================================================

// Share Link - Shareable links for templates/versions
model ShareLink {
  id           String   @id @default(uuid())

  // Target entity
  entityType   String   // template | version | dataset | rubric
  entityId     String

  // Token for access
  token        String   @unique @default(uuid())

  // Permissions
  permission   String   @default("view") // view | comment | duplicate

  // Expiration
  expiresAt    DateTime?
  maxViews     Int?
  viewCount    Int      @default(0)

  // Password protection (hashed)
  passwordHash String?

  // Status
  isActive     Boolean  @default(true)
  revokedAt    DateTime?
  revokedById  String?

  // Multi-tenant support
  workspaceId  String?
  createdById  String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([token])
  @@index([entityType, entityId])
  @@index([workspaceId])
  @@index([createdById])
  @@index([isActive])
  @@index([expiresAt])
}

// Version Comment - Comments on template versions
model VersionComment {
  id              String   @id @default(uuid())
  versionId       String

  // Comment content
  content         String

  // Position in prompt (optional)
  // Structure: { section: "system"|"developer"|"user", start: number, end: number }
  positionJson    Json?

  // Thread support
  parentId        String?
  parent          VersionComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies         VersionComment[] @relation("CommentReplies")

  // Status
  resolved        Boolean  @default(false)
  resolvedAt      DateTime?
  resolvedById    String?

  // Multi-tenant support
  workspaceId     String?
  createdById     String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([versionId])
  @@index([parentId])
  @@index([workspaceId])
  @@index([createdById])
  @@index([resolved])
}
